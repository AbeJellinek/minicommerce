<table class="ui table">
  <thead>
    <tr>
        <th>Item</th>
        <th>Price</th>
        <th>Quantity</th>
    </tr>
  </thead>
  <tbody>
    {{#each cart}}
    <tr>
        <td>{{product.name}}</td>
        <td>{{product.prettyPrice}}</td>
        <td>
            <div data-item="{{product.id}}" class="ui small icon input">
                <input {{#if cartReadOnly}}readonly{{/if}} class="changeQuantity" type="number" min="1" value="{{quantity}}">
                {{#unless cartReadOnly}}<i class="remove icon link removeItemButton"></i>{{/unless}}
            </div>
        </td>
    </tr>
    {{/each}}
    <tr class="positive">
        <td><b>Total</b></td>
        <td class="cartTotal">{{cart.prettyTotal}}</td>
        <td></td>
    </tr>
  </tbody>
</table>


{{#unless cartReadOnly}}
<script type="text/javascript">
    $(function () {
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        $(document).ajaxSend(function(e, xhr, options) {
            xhr.setRequestHeader(header, token);
        });

        $('.changeQuantity').each(function (i, field) {
            var item = $(field).parent();
            var itemId = item.data('item');
            $(field).api({
                url: '/cart/quantity/{id}/{value}',
                urlData: {
                    id: itemId
                },
                method: 'POST',
                stateContext: "div[data-item='" + itemId + "']",
                onSuccess: function (data) {
                    $(document).trigger('updateCart', [data]);
                }
            });
        });

        $('.removeItemButton').each(function (i, button) {
            var item = $(button).parent();
            var itemId = item.data('item');
            $(button).api({
                url: '/cart/remove/{id}',
                urlData: {
                    id: itemId
                },
                method: 'POST',
                stateContext: "div[data-item='" + itemId + "']",
                onSuccess: function (data) {
                    $(document).trigger('updateCart', [data]);
                    item.closest('tr').remove();
                }
            });
        });

        $(document).on('updateCart', function (event, data) {
            $('#navCartTotal').text(data.cart.totalQuantity);
            $('.cartTotal').text(data.cart.prettyTotal);
        });
    })
</script>
{{/unless}}